<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>C Chord Badge</title>
<style>
  :root{
    --line:#242837; --text:#e8eaf0; --muted:#a7adbb;
    --accent:#8bf5c1; --warn:#ffd166;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:transparent; color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial;
  }
  .wrap{padding:14px}
  .card{
    background:linear-gradient(180deg,rgba(18,20,26,.95),rgba(18,20,26,.75));
    border:1px solid var(--line);
    border-radius:18px;
    padding:16px;
    box-shadow: 0 10px 34px rgba(0,0,0,.36);
    backdrop-filter: blur(10px);
  }

  .top{
    display:flex; justify-content:space-between; align-items:flex-end;
    gap:10px; flex-wrap:wrap; margin-bottom:12px;
  }
  .title{
    font-size:22px; font-weight:900; letter-spacing:.2px;
  }
  .subtitle{font-size:12px; color:var(--muted); margin-top:4px}

  .section{margin:10px 0}
  .label{font-size:12px; color:var(--muted); margin-bottom:6px}
  .options{display:flex; gap:6px; flex-wrap:wrap}
  .opt{
    border:1px solid var(--line);
    background:rgba(0,0,0,.25);
    color:var(--text);
    padding:7px 12px;
    border-radius:999px;
    font-weight:800;
    cursor:pointer;
    user-select:none;
  }
  .opt.on{
    background:rgba(139,245,193,.2);
    border-color:rgba(139,245,193,.7);
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 260px;
    gap:12px;
    align-items:stretch;
  }
  @media (max-width: 860px){
    .grid{grid-template-columns:1fr}
  }

  .panel{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(0,0,0,.14);
    padding:12px;
  }
  .pill{
    display:flex; align-items:baseline; justify-content:center; gap:10px;
    padding:10px 14px;
    border:1px solid var(--line);
    border-radius:999px;
    background:rgba(0,0,0,.18);
    font-variant-numeric: tabular-nums;
  }
  .pill .name{font-size:28px; font-weight:900; letter-spacing:.2px}
  .pill .type{font-size:12px; color:var(--muted); font-weight:900; letter-spacing:.8px; text-transform:uppercase}

  .metaRow{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:12px;
    background:rgba(0,0,0,.12);
    padding:10px;
    font-size:12px;
    color:var(--muted);
    line-height:1.55;
  }

  /* SVG host */
  #svgHost{width:100%}
  svg{display:block; width:100%; height:auto}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div>
        <div class="title" id="title">C Major</div>
        <div class="subtitle">옵션을 눌러 운지(보이싱)가 자동 추천됩니다</div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div id="svgHost"></div>
      </div>

      <div class="panel">
        <div class="pill">
          <div class="name" id="pillName">C</div>
          <div class="type" id="pillType">MAJOR</div>
        </div>

        <div class="section">
          <div class="label">Base</div>
          <div class="options" id="baseOpts"></div>
        </div>

        <div class="section">
          <div class="label">Modifiers</div>
          <div class="options" id="modOpts"></div>
        </div>

        <div class="metaRow" id="metaText">
          • X = 뮤트, O = 오픈<br/>
          • 손가락 숫자(1~4), 바레(Barre) 표시 지원
        </div>
      </div>
    </div>
  </div>
</div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  // ======================
  // 1) UI 옵션 정의
  // ======================
  const BASES = [
    { key:"maj", label:"Major" },
    { key:"min", label:"Minor" },
    { key:"7",   label:"7" } // ✅ Dominant 대신 7
  ];
  const MODS = [
    { key:"sus4", label:"sus4" },
    { key:"add9", label:"add9" },
    { key:"11",   label:"11" },
    { key:"13",   label:"13" },
  ];

  // ======================
  // 2) 보이싱(운지) 라이브러리 (C 전용)
  // shape: [E, A, D, G, B, e]  (X or 0 or fret number)
  // fingers: same length, 0 for none/open/mute, 1~4 for finger number
  // barre: {fret, from: stringIndex, to: stringIndex, finger}
  // stringIndex: 0(E) 1(A) 2(D) 3(G) 4(B) 5(e)
  // priority 낮을수록 우선 추천
  // ======================
  const VOICINGS = [
    // C Major (open)
    { id:"C", key:"maj", mods:[], priority:1,
      shape:["X",3,2,0,1,0],
      fingers:[0,3,2,0,1,0]
    },
    // C add9 (open-friendly)
    { id:"Cadd9", key:"maj", mods:["add9"], priority:1,
      shape:["X",3,2,0,3,0],
      fingers:[0,2,1,0,3,0]
    },
    // Csus4
    { id:"Csus4", key:"maj", mods:["sus4"], priority:1,
      shape:["X",3,3,0,1,1],
      fingers:[0,3,4,0,1,2]
    },
    // C7 (open)
    { id:"C7", key:"7", mods:[], priority:1,
      shape:["X",3,2,3,1,0],
      fingers:[0,3,2,4,1,0]
    },
    // C7sus4
    { id:"C7sus4", key:"7", mods:["sus4"], priority:1,
      shape:["X",3,3,3,1,1],
      fingers:[0,3,4,2,1,1],
      barre:{ fret:1, from:4, to:5, finger:1 }
    },
    // C13 (compact guitar voicing with partial barre at 5)
    { id:"C13", key:"7", mods:["13"], priority:1,
      shape:["X",3,2,3,5,5],
      fingers:[0,2,1,3,4,4],
      barre:{ fret:5, from:4, to:5, finger:4 }
    },
    // C11 (기타에서 3도 충돌 회피 → 보통 7sus4로 처리)
    { id:"C11", key:"7", mods:["11"], priority:1,
      shape:["X",3,3,3,1,1],
      fingers:[0,3,4,2,1,1],
      barre:{ fret:1, from:4, to:5, finger:1 }
    },
    // Cm (barre)
    { id:"Cm", key:"min", mods:[], priority:1,
      shape:["X",3,5,5,4,3],
      fingers:[0,1,3,4,2,1],
      barre:{ fret:3, from:1, to:5, finger:1 } // A~e 3프렛 바레
    },
    // Cm11 (현실적인 생략 보이싱)
    { id:"Cm11", key:"min", mods:["11"], priority:1,
      shape:["X",3,5,3,4,3],
      fingers:[0,1,3,1,2,1],
      barre:{ fret:3, from:1, to:5, finger:1 }
    },
    // Cmin add9 (옵션 조합 예시)
    { id:"Cmadd9", key:"min", mods:["add9"], priority:2,
      shape:["X",3,5,3,3,3],
      fingers:[0,1,3,1,1,1],
      barre:{ fret:3, from:1, to:5, finger:1 }
    },
  ];

  // ======================
  // 3) 선택 상태
  // ======================
  let base = "maj";
  let mods = new Set(); // multi-toggle

  // ======================
  // 4) DOM
  // ======================
  const baseBox = document.getElementById("baseOpts");
  const modBox  = document.getElementById("modOpts");
  const titleEl = document.getElementById("title");
  const pillName= document.getElementById("pillName");
  const pillType= document.getElementById("pillType");
  const metaText= document.getElementById("metaText");
  const svgHost = document.getElementById("svgHost");

  // ======================
  // 5) UI 버튼 생성
  // ======================
  BASES.forEach(b => {
    const btn = document.createElement("div");
    btn.className = "opt" + (b.key===base ? " on" : "");
    btn.textContent = b.label;
    btn.addEventListener("click", () => {
      base = b.key;
      // base 바뀌면 모드 유지하되, 말 안 되는 조합은 자동 정리 (예: maj에 13은 가능하지만 voicing 없을 수 있음)
      [...baseBox.children].forEach(x => x.classList.remove("on"));
      btn.classList.add("on");
      render();
    });
    baseBox.appendChild(btn);
  });

  MODS.forEach(m => {
    const btn = document.createElement("div");
    btn.className = "opt";
    btn.textContent = m.label;
    btn.addEventListener("click", () => {
      if (mods.has(m.key)) mods.delete(m.key);
      else mods.add(m.key);
      btn.classList.toggle("on");
      render();
    });
    modBox.appendChild(btn);
  });

  // ======================
  // 6) 보이싱 선택 로직 (자동 추천)
  // - base, mods를 만족하는 후보 중 priority 가장 낮은 것 선택
  // - exact match 우선, 없으면 "부분 match"로 fallback
  // ======================
  function selectVoicing(){
    const wanted = [...mods].sort();
    const exact = VOICINGS
      .filter(v => v.key === base)
      .filter(v => arrayEq(v.mods.slice().sort(), wanted))
      .sort((a,b) => a.priority - b.priority);

    if (exact.length) return exact[0];

    // fallback: 원하는 mods 중 일부만 만족하는 것(최대 포함)
    const candidates = VOICINGS
      .filter(v => v.key === base)
      .map(v => ({ v, score: intersectionCount(v.mods, wanted) }))
      .sort((a,b) => (b.score - a.score) || (a.v.priority - b.v.priority));

    if (candidates.length && candidates[0].score > 0) return candidates[0].v;

    // 마지막 fallback: base 기본
    const baseOnly = VOICINGS
      .filter(v => v.key === base && v.mods.length === 0)
      .sort((a,b) => a.priority - b.priority);
    return baseOnly[0] || VOICINGS[0];
  }

  function arrayEq(a,b){
    if (a.length !== b.length) return false;
    for (let i=0;i<a.length;i++) if (a[i] !== b[i]) return false;
    return true;
  }
  function intersectionCount(a,b){
    const s = new Set(a);
    let c = 0;
    for (const x of b) if (s.has(x)) c++;
    return c;
  }

  // ======================
  // 7) 코드명(표기) 생성
  // ======================
  function chordName(){
    // C 고정
    let name = "C";
    if (base === "min") name += "m";
    if (base === "7") name += "7";

    // sus4는 3도 대체 개념이라 base와 함께 붙임
    if (mods.has("sus4")){
      // Cm + sus4 같은 건 현실적으로 드묾. 그래도 표시.
      name += "sus4";
    }

    // add9 / 11 / 13
    if (mods.has("add9")) name += (mods.has("11") || mods.has("13") || base==="7") ? "(add9)" : "add9";
    if (mods.has("11")) name += "11";
    if (mods.has("13")) name += "13";
    return name;
  }

  // ======================
  // 8) SVG 지판 렌더러 (이미지처럼 보이게)
  // ======================
  function renderFretboard(vo){
    const shape = vo.shape;
    const fingers = vo.fingers || [0,0,0,0,0,0];

    // 표시 프렛 범위 결정
    const fretted = shape
      .filter(x => x !== "X" && x !== 0)
      .map(x => Number(x));
    const minF = fretted.length ? Math.min(...fretted) : 1;
    const maxF = fretted.length ? Math.max(...fretted) : 4;

    // 오픈코드는 1프렛부터, 하이포지션은 최저프렛 기준
    const startFret = (maxF <= 4) ? 1 : minF;
    const fretCount = 5;              // 5칸 표시
    const endFret = startFret + fretCount - 1;

    // SVG geometry
    const W = 720;
    const H = 320;
    const padL = 64;
    const padR = 26;
    const padT = 56;
    const padB = 34;

    const gridW = W - padL - padR;
    const gridH = H - padT - padB;

    const strings = 6;
    const stringGap = gridW / (strings - 1);
    const fretGap = gridH / fretCount;

    const sx = (i) => padL + i * stringGap;     // string x
    const fy = (f) => padT + f * fretGap;       // fret line y (0..fretCount)

    const ns = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(ns,"svg");
    svg.setAttribute("viewBox", `0 0 ${W} ${H}`);

    // background (transparent inside card)
    const bg = document.createElementNS(ns,"rect");
    bg.setAttribute("x","0"); bg.setAttribute("y","0");
    bg.setAttribute("width",W); bg.setAttribute("height",H);
    bg.setAttribute("rx","14");
    bg.setAttribute("fill","rgba(0,0,0,0)");
    svg.appendChild(bg);

    // fret lines
    for (let f=0; f<=fretCount; f++){
      const y = fy(f);
      const line = document.createElementNS(ns,"line");
      line.setAttribute("x1", padL);
      line.setAttribute("x2", W - padR);
      line.setAttribute("y1", y);
      line.setAttribute("y2", y);
      line.setAttribute("stroke", "rgba(232,234,240,.22)");
      line.setAttribute("stroke-width", (startFret===1 && f===0) ? "5" : "2"); // nut thicker when start at 1
      line.setAttribute("stroke-linecap", "round");
      svg.appendChild(line);
    }

    // string lines
    for (let s=0; s<strings; s++){
      const x = sx(s);
      const line = document.createElementNS(ns,"line");
      line.setAttribute("x1", x);
      line.setAttribute("x2", x);
      line.setAttribute("y1", padT);
      line.setAttribute("y2", padT + gridH);
      line.setAttribute("stroke", "rgba(232,234,240,.18)");
      line.setAttribute("stroke-width", "2");
      line.setAttribute("stroke-linecap", "round");
      svg.appendChild(line);
    }

    // left string labels (E A D G B e)
    const labels = ["E","A","D","G","B","e"];
    for (let s=0;s<strings;s++){
      const t = document.createElementNS(ns,"text");
      t.setAttribute("x", String(padL - 28));
      t.setAttribute("y", String(padT + (gridH/(strings-1))*s + 5));
      t.setAttribute("fill","rgba(167,173,187,.9)");
      t.setAttribute("font-size","12");
      t.setAttribute("font-weight","900");
      t.textContent = labels[s];
      svg.appendChild(t);
    }

    // start fret label if not 1
    if (startFret !== 1){
      const t = document.createElementNS(ns,"text");
      t.setAttribute("x", String(14));
      t.setAttribute("y", String(padT + fretGap*0.78));
      t.setAttribute("fill","rgba(167,173,187,.9)");
      t.setAttribute("font-size","12");
      t.setAttribute("font-weight","900");
      t.textContent = `${startFret}fr`;
      svg.appendChild(t);
    }

    // top markers X / O above nut line area
    for (let s=0; s<strings; s++){
      const v = shape[s];
      if (v !== "X" && v !== 0) continue;
      const t = document.createElementNS(ns,"text");
      t.setAttribute("x", String(sx(s)));
      t.setAttribute("y", String(padT - 20));
      t.setAttribute("text-anchor","middle");
      t.setAttribute("font-size","14");
      t.setAttribute("font-weight","900");
      t.setAttribute("fill", v==="X" ? "rgba(255,209,102,.95)" : "rgba(139,245,193,.95)");
      t.textContent = (v==="X") ? "X" : "O";
      svg.appendChild(t);
    }

    // Barre (capsule)
    if (vo.barre){
      const { fret, from, to, finger } = vo.barre;
      if (fret >= startFret && fret <= endFret){
        const localF = fret - startFret;
        const y = fy(localF) + fretGap/2;

        const x1 = sx(from);
        const x2 = sx(to);
        const rect = document.createElementNS(ns,"rect");
        rect.setAttribute("x", String(Math.min(x1,x2) - 14));
        rect.setAttribute("y", String(y - 13));
        rect.setAttribute("width", String(Math.abs(x2-x1) + 28));
        rect.setAttribute("height", "26");
        rect.setAttribute("rx","13");
        rect.setAttribute("fill","rgba(255,209,102,.18)");
        rect.setAttribute("stroke","rgba(255,209,102,.55)");
        rect.setAttribute("stroke-width","2");
        svg.appendChild(rect);

        const txt = document.createElementNS(ns,"text");
        txt.setAttribute("x", String(Math.min(x1,x2) - 22));
        txt.setAttribute("y", String(y + 5));
        txt.setAttribute("fill","rgba(255,209,102,.95)");
        txt.setAttribute("font-size","12");
        txt.setAttribute("font-weight","900");
        txt.textContent = String(finger);
        svg.appendChild(txt);
      }
    }

    // Finger dots + numbers
    for (let s=0; s<strings; s++){
      const v = shape[s];
      if (v==="X" || v===0) continue;
      const fret = Number(v);
      if (fret < startFret || fret > endFret) continue;

      const localF = fret - startFret;
      const cx = sx(s);
      const cy = fy(localF) + fretGap/2;

      const dot = document.createElementNS(ns,"circle");
      dot.setAttribute("cx", String(cx));
      dot.setAttribute("cy", String(cy));
      dot.setAttribute("r", "13");
      dot.setAttribute("fill", "rgba(139,245,193,.92)");
      dot.setAttribute("stroke", "rgba(0,0,0,.25)");
      dot.setAttribute("stroke-width", "2");
      svg.appendChild(dot);

      const fnum = Number(fingers[s] || 0);
      if (fnum > 0){
        const t = document.createElementNS(ns,"text");
        t.setAttribute("x", String(cx));
        t.setAttribute("y", String(cy + 5));
        t.setAttribute("text-anchor","middle");
        t.setAttribute("fill","rgba(0,0,0,.75)");
        t.setAttribute("font-size","13");
        t.setAttribute("font-weight","900");
        t.textContent = String(fnum);
        svg.appendChild(t);
      }
    }

    return svg;
  }

  // ======================
  // 9) Render
  // ======================
  function render(){
    const vo = selectVoicing();
    const name = chordName();

    titleEl.textContent = name;
    pillName.textContent = "C";
    pillType.textContent = name.replace(/^C/, "").trim() || "MAJOR";

    // meta
    let barreInfo = "";
    if (vo.barre){
      const {fret, finger} = vo.barre;
      barreInfo = `• Barre: finger ${finger} @ ${fret}fr<br/>`;
    }
    metaText.innerHTML =
      `• Recommended voicing: <b>${vo.id}</b><br/>` +
      barreInfo +
      `• X = mute, O = open<br/>` +
      `• Finger numbers shown on dots`;

    // svg
    svgHost.innerHTML = "";
    svgHost.appendChild(renderFretboard(vo));
  }

  // 초기 UI 표시(모드 버튼 on 상태 동기화)
  // (mods는 Set이라 초기에는 off)
  render();
});
</script>
</body>
</html>
